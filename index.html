<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pokémon Team Generator</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 0 10px; }
  label { display: block; margin: 10px 0 5px; }
  button { margin-top: 15px; padding: 8px 12px; cursor: pointer; }
  pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; margin-top: 10px; }
</style>
</head>
<body>
<h1>Pokémon Team Generator</h1>

<label>Generation (1-9):
  <input id="generation" type="number" min="1" max="9" value="1" />
</label>

<label>
  <input id="fullyEvolved" type="checkbox" />
  Only fully evolved Pokémon
</label>

<label>
  <input id="randomizeEVs" type="checkbox" />
  Randomize EVs
</label>

<label>
  <input id="randomizeItems" type="checkbox" />
  Randomize Held Items
</label>


<button id="generateBtn">Generate Team</button>
<button id="exportBtn" style="display:none;">Export Showdown Format</button>

<pre id="output"></pre>

<script>
const pokeApiBase = 'https://pokeapi.co/api/v2';

const itemPoolByGen = {
  1: [''],
  2: ["Leftovers",
  "Berserk Gene",
  "Black Belt",
  "Black Glasses",
  "Bright Powder",
  "Charcoal",
  "Dragon Scale",
  "Gold Berry",
  "Hard Stone",
  "King's Rock",
  "Magnet",
  "Metal Coat",
  "Mint Berry",
  "MiracleBerry",
  "Miracle Seed",
  "MysteryBerry",
  "Mystic Water",
  "Never-Melt Ice",
  "Pink Bow",
  "Poison Barb",
  "Polkadot Bow",
  "Quick Claw",
  "Scope Lens",
  "Sharp Beak",
  "Silver Powder",
  "Soft Sand",
  "Spell Tag",
  "Twisted Spoon"],
  3: ["Choice Band",
  "Leftovers",
  "Lum Berry",
  "Salac Berry",
  "Apicot Berry",
  "Black Belt",
  "Black Glasses",
  "Bright Powder",
  "Charcoal",
  "Chesto Berry",
  "Dragon Fang",
  "Ganlon Berry",
  "Hard Stone",
  "King's Rock",
  "Lansat Berry",
  "Leppa Berry",
  "Liechi Berry",
  "Magnet",
  "Metal Coat",
  "Miracle Seed",
  "Mystic Water",
  "Never-Melt Ice",
  "Petaya Berry",
  "Poison Barb",
  "Quick Claw",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shell Bell",
  "Silk Scarf",
  "Silver Powder",
  "Soft Sand",
  "Spell Tag",
  "Starf Berry",
  "Twisted Spoon",
  "White Herb"],
  4: [  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Focus Sash",
  "Leftovers",
  "Life Orb",
  "Lum Berry",
  "Power Herb",
  "Salac Berry",
  "Sitrus Berry",
  "Apicot Berry",
  "Babiri Berry",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Bright Powder",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Coba Berry",
  "Colbur Berry",
  "Custap Berry",
  "Damp Rock",
  "Draco Plate",
  "Dragon Fang",
  "Dread Plate",
  "Earth Plate",
  "Fist Plate",
  "Flame Orb",
  "Flame Plate",
  "Ganlon Berry",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Icicle Plate",
  "Icy Rock",
  "Insect Plate",
  "Iron Plate",
  "Kasib Berry",
  "Kebia Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Lax Incense",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Magnet",
  "Meadow Plate",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Mind Plate",
  "Miracle Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Occa Berry",
  "Odd Incense",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Poison Barb",
  "Quick Claw",
  "Razor Claw",
  "Razor Fang",
  "Rindo Berry",
  "Rock Incense",
  "Rose Incense",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sky Plate",
  "Smooth Rock",
  "Soft Sand",
  "Spell Tag",
  "Splash Plate",
  "Spooky Plate",
  "Starf Berry",
  "Stone Plate",
  "Tanga Berry",
  "Toxic Orb",
  "Toxic Plate",
  "Twisted Spoon",
  "Wacan Berry",
  "Wave Incense",
  "White Herb",
  "Wide Lens",
  "Wise Glasses",
  "Yache Berry",
  "Zap Plate"],
  5: [  "Air Balloon",
  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Focus Sash",
  "Leftovers",
  "Life Orb",
  "Lum Berry",
  "Mental Herb",
  "Power Herb",
  "Rocky Helmet",
  "Salac Berry",
  "Sitrus Berry",
  "Absorb Bulb",
  "Apicot Berry",
  "Babiri Berry",
  "Berry Juice",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Bright Powder",
  "Bug Gem",
  "Cell Battery",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Coba Berry",
  "Colbur Berry",
  "Custap Berry",
  "Damp Rock",
  "Dark Gem",
  "Draco Plate",
  "Dragon Fang",
  "Dragon Gem",
  "Dread Plate",
  "Earth Plate",
  "Eject Button",
  "Electric Gem",
  "Fighting Gem",
  "Fire Gem",
  "Fist Plate",
  "Flame Orb",
  "Flame Plate",
  "Flying Gem",
  "Full Incense",
  "Ganlon Berry",
  "Ghost Gem",
  "Grass Gem",
  "Grepa Berry",
  "Grip Claw",
  "Ground Gem",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Ice Gem",
  "Icicle Plate",
  "Icy Rock",
  "Insect Plate",
  "Iron Plate",
  "Kasib Berry",
  "Kebia Berry",
  "Kelpsy Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Lax Incense",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Magnet",
  "Mail",
  "Meadow Plate",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Mind Plate",
  "Miracle Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Normal Gem",
  "Occa Berry",
  "Odd Incense",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Poison Barb",
  "Poison Gem",
  "Psychic Gem",
  "Quick Claw",
  "Razor Claw",
  "Razor Fang",
  "Red Card",
  "Rindo Berry",
  "Rock Gem",
  "Rock Incense",
  "Rose Incense",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sky Plate",
  "Smooth Rock",
  "Soft Sand",
  "Spell Tag",
  "Splash Plate",
  "Spooky Plate",
  "Starf Berry",
  "Steel Gem",
  "Sticky Barb",
  "Stone Plate",
  "Tanga Berry",
  "Toxic Orb",
  "Toxic Plate",
  "Twisted Spoon",
  "Wacan Berry",
  "Water Gem",
  "Wave Incense",
  "White Herb",
  "Wide Lens",
  "Wise Glasses",
  "Yache Berry",
  "Zap Plate",
  "Zoom Lens"],
  6:[  "Air Balloon",
  "Assault Vest",
  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Focus Sash",
  "Leftovers",
  "Life Orb",
  "Lum Berry",
  "Mental Herb",
  "Power Herb",
  "Rocky Helmet",
  "Salac Berry",
  "Sitrus Berry",
  "Absorb Bulb",
  "Apicot Berry",
  "Babiri Berry",
  "Berry Juice",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Bright Powder",
  "Cell Battery",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Coba Berry",
  "Colbur Berry",
  "Custap Berry",
  "Damp Rock",
  "Draco Plate",
  "Dragon Fang",
  "Dread Plate",
  "Earth Plate",
  "Eject Button",
  "Fist Plate",
  "Flame Orb",
  "Flame Plate",
  "Full Incense",
  "Ganlon Berry",
  "Grepa Berry",
  "Grip Claw",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Icicle Plate",
  "Icy Rock",
  "Insect Plate",
  "Iron Plate",
  "Kasib Berry",
  "Kebia Berry",
  "Kee Berry",
  "Kelpsy Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Lax Incense",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Luminous Moss",
  "Magnet",
  "Maranga Berry",
  "Meadow Plate",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Mind Plate",
  "Miracle Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Normal Gem",
  "Occa Berry",
  "Odd Incense",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Pixie Plate",
  "Poison Barb",
  "Quick Claw",
  "Razor Claw",
  "Razor Fang",
  "Red Card",
  "Rindo Berry",
  "Rock Incense",
  "Rose Incense",
  "Roseli Berry",
  "Safety Goggles",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sky Plate",
  "Smooth Rock",
  "Snowball",
  "Soft Sand",
  "Spell Tag",
  "Splash Plate",
  "Spooky Plate",
  "Starf Berry",
  "Sticky Barb",
  "Stone Plate",
  "Tanga Berry",
  "Toxic Orb",
  "Toxic Plate",
  "Twisted Spoon",
  "Wacan Berry",
  "Wave Incense",
  "Weakness Policy",
  "White Herb",
  "Wide Lens",
  "Wise Glasses",
  "Yache Berry",
  "Zap Plate",
  "Zoom Lens"],
  7: ["Aguav Berry",
  "Air Balloon",
  "Assault Vest",
  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Figy Berry",
  "Focus Sash",
  "Iapapa Berry",
  "Leftovers",
  "Life Orb",
  "Mago Berry",
  "Mental Herb",
  "Power Herb",
  "Rocky Helmet",
  "Salac Berry",
  "Wiki Berry",
  "Absorb Bulb",
  "Adrenaline Orb",
  "Apicot Berry",
  "Babiri Berry",
  "Berry Juice",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Bright Powder",
  "Buginium Z",
  "Cell Battery",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Coba Berry",
  "Colbur Berry",
  "Custap Berry",
  "Damp Rock",
  "Darkinium Z",
  "Draco Plate",
  "Dragon Fang",
  "Dragonium Z",
  "Dread Plate",
  "Earth Plate",
  "Eject Button",
  "Electric Seed",
  "Electrium Z",
  "Fairium Z",
  "Fightinium Z",
  "Firium Z",
  "Fist Plate",
  "Flame Orb",
  "Flame Plate",
  "Flyinium Z",
  "Full Incense",
  "Ganlon Berry",
  "Ghostium Z",
  "Grassium Z",
  "Grassy Seed",
  "Grepa Berry",
  "Grip Claw",
  "Groundium Z",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Icicle Plate",
  "Icium Z",
  "Icy Rock",
  "Insect Plate",
  "Iron Plate",
  "Kasib Berry",
  "Kebia Berry",
  "Kee Berry",
  "Kelpsy Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Lax Incense",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Lum Berry",
  "Luminous Moss",
  "Magnet",
  "Maranga Berry",
  "Meadow Plate",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Mind Plate",
  "Miracle Seed",
  "Misty Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Normal Gem",
  "Normalium Z",
  "Occa Berry",
  "Odd Incense",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Pixie Plate",
  "Poison Barb",
  "Poisonium Z",
  "Protective Pads",
  "Psychic Seed",
  "Psychium Z",
  "Quick Claw",
  "Razor Claw",
  "Razor Fang",
  "Red Card",
  "Rindo Berry",
  "Rock Incense",
  "Rockium Z",
  "Rose Incense",
  "Roseli Berry",
  "Safety Goggles",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sitrus Berry",
  "Sky Plate",
  "Smooth Rock",
  "Snowball",
  "Soft Sand",
  "Spell Tag",
  "Splash Plate",
  "Spooky Plate",
  "Starf Berry",
  "Steelium Z",
  "Sticky Barb",
  "Stone Plate",
  "Tanga Berry",
  "Terrain Extender",
  "Toxic Orb",
  "Toxic Plate",
  "Twisted Spoon",
  "Wacan Berry",
  "Waterium Z",
  "Wave Incense",
  "Weakness Policy",
  "White Herb",
  "Wide Lens",
  "Wise Glasses",
  "Yache Berry",
  "Zap Plate",
  "Zoom Lens"],
  8: ["Air Balloon",
  "Assault Vest",
  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Focus Sash",
  "Heavy-Duty Boots",
  "Leftovers",
  "Life Orb",
  "Mental Herb",
  "Power Herb",
  "Rocky Helmet",
  "Salac Berry",
  "Absorb Bulb",
  "Adrenaline Orb",
  "Aguav Berry",
  "Apicot Berry",
  "Babiri Berry",
  "Berry Juice",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Blunder Policy",
  "Bright Powder",
  "Cell Battery",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Coba Berry",
  "Colbur Berry",
  "Custap Berry",
  "Damp Rock",
  "Dragon Fang",
  "Eject Button",
  "Eject Pack",
  "Electric Seed",
  "Figy Berry",
  "Flame Orb",
  "Full Incense",
  "Ganlon Berry",
  "Grassy Seed",
  "Grepa Berry",
  "Grip Claw",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Iapapa Berry",
  "Icy Rock",
  "Kasib Berry",
  "Kebia Berry",
  "Kee Berry",
  "Kelpsy Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Lax Incense",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Lum Berry",
  "Luminous Moss",
  "Magnet",
  "Mago Berry",
  "Maranga Berry",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Miracle Seed",
  "Misty Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Normal Gem",
  "Occa Berry",
  "Odd Incense",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Pixie Plate",
  "Poison Barb",
  "Protective Pads",
  "Psychic Seed",
  "Quick Claw",
  "Razor Claw",
  "Red Card",
  "Rindo Berry",
  "Rock Incense",
  "Room Service",
  "Rose Incense",
  "Roseli Berry",
  "Safety Goggles",
  "Scope Lens",
  "Sea Incense",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sitrus Berry",
  "Smooth Rock",
  "Snowball",
  "Soft Sand",
  "Spell Tag",
  "Starf Berry",
  "Sticky Barb",
  "Tanga Berry",
  "Terrain Extender",
  "Throat Spray",
  "Toxic Orb",
  "Twisted Spoon",
  "Utility Umbrella",
  "Wacan Berry",
  "Wave Incense",
  "Weakness Policy",
  "White Herb",
  "Wide Lens",
  "Wiki Berry",
  "Wise Glasses",
  "Yache Berry",
  "Zoom Lens"],
  9: [ "Air Balloon",
  "Assault Vest",
  "Choice Band",
  "Choice Scarf",
  "Choice Specs",
  "Expert Belt",
  "Focus Sash",
  "Heavy-Duty Boots",
  "Leftovers",
  "Life Orb",
  "Loaded Dice",
  "Mental Herb",
  "Power Herb",
  "Rocky Helmet",
  "Salac Berry",
  "Ability Shield",
  "Absorb Bulb",
  "Adrenaline Orb",
  "Aguav Berry",
  "Apicot Berry",
  "Babiri Berry",
  "Black Belt",
  "Black Glasses",
  "Black Sludge",
  "Blunder Policy",
  "Booster Energy",
  "Bright Powder",
  "Cell Battery",
  "Charcoal",
  "Charti Berry",
  "Chesto Berry",
  "Chilan Berry",
  "Chople Berry",
  "Clear Amulet",
  "Coba Berry",
  "Colbur Berry",
  "Covert Cloak",
  "Custap Berry",
  "Damp Rock",
  "Draco Plate",
  "Dragon Fang",
  "Dread Plate",
  "Earth Plate",
  "Eject Button",
  "Eject Pack",
  "Electric Seed",
  "Fairy Feather",
  "Figy Berry",
  "Fist Plate",
  "Flame Orb",
  "Flame Plate",
  "Ganlon Berry",
  "Grassy Seed",
  "Grepa Berry",
  "Grip Claw",
  "Haban Berry",
  "Hard Stone",
  "Heat Rock",
  "Iapapa Berry",
  "Icicle Plate",
  "Icy Rock",
  "Insect Plate",
  "Iron Plate",
  "Kasib Berry",
  "Kebia Berry",
  "Kee Berry",
  "Kelpsy Berry",
  "King's Rock",
  "Lagging Tail",
  "Lansat Berry",
  "Leppa Berry",
  "Liechi Berry",
  "Light Clay",
  "Lum Berry",
  "Luminous Moss",
  "Magnet",
  "Mago Berry",
  "Maranga Berry",
  "Meadow Plate",
  "Metal Coat",
  "Metronome",
  "Micle Berry",
  "Mind Plate",
  "Miracle Seed",
  "Mirror Herb",
  "Misty Seed",
  "Muscle Band",
  "Mystic Water",
  "Never-Melt Ice",
  "Normal Gem",
  "Occa Berry",
  "Passho Berry",
  "Payapa Berry",
  "Petaya Berry",
  "Pixie Plate",
  "Poison Barb",
  "Protective Pads",
  "Psychic Seed",
  "Punching Glove",
  "Quick Claw",
  "Razor Claw",
  "Razor Fang",
  "Red Card",
  "Rindo Berry",
  "Room Service",
  "Roseli Berry",
  "Safety Goggles",
  "Scope Lens",
  "Sharp Beak",
  "Shed Shell",
  "Shell Bell",
  "Shuca Berry",
  "Silk Scarf",
  "Silver Powder",
  "Sitrus Berry",
  "Sky Plate",
  "Smooth Rock",
  "Snowball",
  "Soft Sand",
  "Spell Tag",
  "Splash Plate",
  "Spooky Plate",
  "Starf Berry",
  "Sticky Barb",
  "Stone Plate",
  "Tanga Berry",
  "Terrain Extender",
  "Throat Spray",
  "Toxic Orb",
  "Toxic Plate",
  "Twisted Spoon",
  "Utility Umbrella",
  "Wacan Berry",
  "Weakness Policy",
  "White Herb",
  "Wide Lens",
  "Wiki Berry",
  "Wise Glasses",
  "Yache Berry",
  "Zap Plate",
  "Zoom Lens"]
}

const genToVersionGroups = {
  1: ['red-blue', 'yellow'],
  2: ['gold-silver', 'crystal'],
  3: ['ruby-sapphire', 'emerald', 'fire-red-leaf-green'],
  4: ['diamond-pearl', 'platinum', 'heartgold-soulsilver'],
  5: ['black-white', 'black-2-white-2'],
  6: ['x-y', 'omega-ruby-alpha-sapphire'],
  7: ['sun-moon', 'ultra-sun-ultra-moon'],
  8: ['sword-shield'],
  9: ['scarlet-violet']
};


async function fetchJson(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function getGenerationPokemon(gen) {
  const data = await fetchJson(`${pokeApiBase}/generation/${gen}`);
  return data.pokemon_species.map(species => ({
    name: species.name,
    url: species.url,
  }));
}



function pickRandom(arr, n) {
  const result = [];
  const copy = [...arr];
  const limit = Math.min(n, copy.length);
  for (let i = 0; i < limit; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    result.push(copy[idx]);
    copy.splice(idx, 1);
  }
  return result;
}

async function getPokemonData(name, gen) {
  try {
    const data = await fetchJson(`${pokeApiBase}/pokemon/${name}`);
    
    const allowedVersionGroups = genToVersionGroups[gen] || [];

    // Filter moves to only those available in allowed version groups
    const filteredMoves = data.moves.filter(moveEntry => {
      // moveEntry.version_group_details is an array describing which version groups this move is learnable in
      return moveEntry.version_group_details.some(vgd =>
        allowedVersionGroups.includes(vgd.version_group.name)
      );
    }).map(m => m.move.name);

    // For abilities, filtering by gen introduced is still okay:
    const filteredAbilities = [];
    for (const abilityEntry of data.abilities) {
      const abilityGen = await getAbilityGen(abilityEntry.ability.name);
      if (abilityGen <= gen) filteredAbilities.push(abilityEntry.ability.name);
    }

    return {
      name: data.name,
      moves: filteredMoves,
      abilities: filteredAbilities,
    };
  } catch (err) {
    console.warn(`Failed to fetch data for ${name}: ${err.message}`);
    return null;
  }
}

function getFinalEvolutions(chain) {
  // Recursive function to find all final species names in the evolution chain
  if (!chain.evolves_to || chain.evolves_to.length === 0) {
    return [chain.species.name];
  }
  let finals = [];
  for (const evo of chain.evolves_to) {
    finals = finals.concat(getFinalEvolutions(evo));
  }
  return finals;
}


async function fetchEvolutionChains(speciesList) {
  // Map from evo chain url to array of species names that are final evolutions
  const evoChainMap = new Map();

  // Get all unique evolution_chain urls
  const evoUrls = new Set();
  const speciesToEvoUrl = {};

  // Fetch species data in parallel
  const speciesDataArr = await Promise.all(
    speciesList.map(s => fetchJson(`${pokeApiBase}/pokemon-species/${s.name}`))
  );

  speciesDataArr.forEach(speciesData => {
    const evoUrl = speciesData.evolution_chain.url;
    evoUrls.add(evoUrl);
    speciesToEvoUrl[speciesData.name] = evoUrl;
  });

  // Fetch all evolution chains in parallel
  const evoChains = await Promise.all(
    [...evoUrls].map(url => fetchJson(url))
  );

  // Parse all final evolutions
  evoChains.forEach((chainData, i) => {
    const url = [...evoUrls][i];
    const finals = getFinalEvolutions(chainData.chain);
    evoChainMap.set(url, finals);
  });

  // Return a map: species name => boolean if fully evolved
  const evoInfoMap = {}; // { speciesName: { isFinal: bool, hasEvolutions: bool } }

  for (const s of speciesList) {
    const evoUrl = speciesToEvoUrl[s.name];
    const finalForms = evoChainMap.get(evoUrl);
    const isFinal = finalForms.includes(s.name);
    const hasEvolutions = finalForms.length > 0 && !isFinal;
    evoInfoMap[s.name] = {
      isFinal,
      hasEvolutions
  };
}

  return evoInfoMap;
}

// Modified generateTeam to use this:

async function generateTeam(gen, onlyFullyEvolved, randomizeEVs, randomizeItems) {
  let speciesList = await getGenerationPokemon(gen);

  let evoInfoMap = null;
  if (onlyFullyEvolved || randomizeItems) {
    // Need this map for item legality too
    evoInfoMap = await fetchEvolutionChains(speciesList);
    if (onlyFullyEvolved) {
      speciesList = speciesList.filter(s => evoInfoMap[s.name]?.isFinal);
    }
  }

  speciesList = speciesList.sort(() => Math.random() - 0.5);

  const sampleSize = Math.min(speciesList.length, 40);
  const sample = speciesList.slice(0, sampleSize);

  const batchSize = 10;
  let team = [];
  for (let i = 0; i < sample.length && team.length < 6; i += batchSize) {
    const batch = sample.slice(i, i + batchSize);
    const datas = await Promise.all(batch.map(s => getPokemonData(s.name, gen)));
    for (const data of datas) {
      if (!data) continue;
      const moves = pickRandom(data.moves, 4);
      const ability = pickRandom(data.abilities, 1)[0];
      const speciesName = data.name.toLowerCase();
      const evoInfo = evoInfoMap ? evoInfoMap[speciesName] : { isFinal: false, hasEvolutions: true };
      const isFullyEvolved = evoInfo.isFinal;
      const canEvolve = evoInfo.hasEvolutions;
      const item = randomizeItems ? randomItem(isFullyEvolved, canEvolve, gen) : '[Item]';




      team.push({
        name: capitalize(data.name),
        moves,
        ability,
        evs: randomizeEVs ? randomEVSpread() : '252 Atk / 252 Spe / 4 HP',
        nature: randomizeEVs ? randomNature() : 'Adamant',
        item
      });

      if (team.length >= 6) break;
    }
  }

  if (team.length < 6) {
    throw new Error('Not enough Pokémon to generate a full team');
  }

  return team;
}




function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

const genCache = {
  moves: new Map(),     // moveName -> genNumber
  abilities: new Map(), // abilityName -> genNumber
};

async function getMoveGen(moveName) {
  if (genCache.moves.has(moveName)) return genCache.moves.get(moveName);
  const data = await fetchJson(`${pokeApiBase}/move/${moveName}`);
  // The generation URL is like "/api/v2/generation/3/"
  const genUrl = data.generation.url;
  const genNum = parseInt(genUrl.match(/generation\/(\d+)\//)[1]);
  genCache.moves.set(moveName, genNum);
  return genNum;
}

async function getAbilityGen(abilityName) {
  if (genCache.abilities.has(abilityName)) return genCache.abilities.get(abilityName);
  const data = await fetchJson(`${pokeApiBase}/ability/${abilityName}`);
  const genUrl = data.generation.url;
  const genNum = parseInt(genUrl.match(/generation\/(\d+)\//)[1]);
  genCache.abilities.set(abilityName, genNum);
  return genNum;
}

async function filterMovesAbilitiesByGen(moves, abilities, gen) {
  // Filter moves
  const filteredMoves = [];
  for (const moveName of moves) {
    const moveGen = await getMoveGen(moveName);
    if (moveGen <= gen) filteredMoves.push(moveName);
  }
  
  // Filter abilities
  const filteredAbilities = [];
  for (const abilityName of abilities) {
    const abilityGen = await getAbilityGen(abilityName);
    if (abilityGen <= gen) filteredAbilities.push(abilityName);
  }
  
  return { moves: filteredMoves, abilities: filteredAbilities };
}



function randomEVSpread() {
  const stats = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
  const evs = {};
  let remaining = 508;

  stats.forEach(stat => evs[stat] = 0);

  while (remaining > 0) {
    const stat = stats[Math.floor(Math.random() * stats.length)];
    const add = Math.min(remaining, Math.floor(Math.random() * 64));
    if (evs[stat] + add <= 252) {
      evs[stat] += add;
      remaining -= add;
    }
  }

  return stats.filter(s => evs[s] > 0).map(s => `${evs[s]} ${s}`).join(' / ');
}

function randomNature() {
  const natures = [
    'Adamant', 'Modest', 'Jolly', 'Timid', 'Brave', 'Calm', 'Impish', 'Bold',
    'Careful', 'Hardy', 'Hasty', 'Lonely', 'Mild', 'Naive', 'Quiet', 'Rash',
    'Relaxed', 'Sassy', 'Serious', 'Docile', 'Lax', 'Gentle', 'Bashful', 'Quirky', 'Naughty'
  ];
  return natures[Math.floor(Math.random() * natures.length)];
}

function getItemPoolForGen(gen) {
  return itemPoolByGen[gen] || [];
}

function randomItem(isFullyEvolved, canEvolve, gen) {
  console.log('Random Item Gen:', gen);
  let items = getItemPoolForGen(gen);

  if (!(canEvolve && !isFullyEvolved)) {
    items = items.filter(i => i !== 'Eviolite');
  }
  return items[Math.floor(Math.random() * items.length)];
}




function showdownFormat(team) {
  return team.map(poke => {
    return `${poke.name} @ ${poke.item}
Ability: ${capitalize(poke.ability)}
Level: 100
EVs: ${poke.evs}
Nature: ${poke.nature}
- ${poke.moves.map(capitalize).join('\n- ')}`;
  }).join('\n\n');
}


const output = document.getElementById('output');
const generateBtn = document.getElementById('generateBtn');
const exportBtn = document.getElementById('exportBtn');

let currentTeam = null;

generateBtn.onclick = async () => {
  output.textContent = 'Generating team, please wait...';
  exportBtn.style.display = 'none';
  currentTeam = null;

  const gen = parseInt(document.getElementById('generation').value);
  const onlyFullyEvolved = document.getElementById('fullyEvolved').checked;
  const randomizeEVs = document.getElementById('randomizeEVs').checked;
  const randomizeItems = document.getElementById('randomizeItems').checked;

  try {
    const team = await generateTeam(gen, onlyFullyEvolved, randomizeEVs, randomizeItems);
    if (team.length < 6) {
      output.textContent = 'Could not generate full team (not enough Pokémon matching criteria).';
      return;
    }
    currentTeam = team;
    let displayText = '';
    team.forEach((poke, idx) => {
      displayText += `${idx + 1}. ${poke.name}\nItem: ${poke.item}\nAbility: ${poke.ability}\nEVs: ${poke.evs}\nNature: ${poke.nature}\nMoves: ${poke.moves.join(', ')}\n\n`;
    });

    output.textContent = displayText;
    exportBtn.style.display = 'inline-block';
  } catch (err) {
    output.textContent = 'Error: ' + err.message;
  }
};

exportBtn.onclick = () => {
  if (!currentTeam) return;
  const text = showdownFormat(currentTeam);
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pokemon_team.txt';
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
